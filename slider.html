<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
  let anunciosData = [];
  let swiperInstance = null; // Guardamos la instancia de Swiper aqu√≠

  async function cargarImagenes() {
    try {
      const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      anunciosData = data.anuncios;

      // üìå Si no hay anuncios reales, inventamos uno
      if (!anunciosData || anunciosData.length === 0) {
        anunciosData = [{
          titulo: "gf",
          descripcion: "90",
          url: "https://drive.google.com/uc?export=view&id=1XBqcfXi4rkF5yvz6E_oHd3lTxc7xN9il",
          comentarios: "de: Deimer Herrera  holaaaaa 14/8/2025, 1:40:01 p.m. | deimer.herrera91@gmail.com",
          deleteURL: "1XBqcfXi4rkF5yvz6E_oHd3lTxc7xN9il",
          autor: "d",
          correo: "d@gmai.com",
          fecha: "12/8/2025, 5:54:00 p.m."
        }];
      }

      const swiperWrapper = document.querySelector('.swiper-wrapper');
      const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;
      const newTotalSlides = anunciosData.length;

      swiperWrapper.innerHTML = '';
      
      anunciosData.forEach((anuncio) => {
        const slide = document.createElement('div');
        slide.classList.add('swiper-slide');
        slide.dataset.anuncio = JSON.stringify(anuncio);
        
        const img = document.createElement('img');
        img.src = anuncio.url;
        img.alt = "";
        
        const overlay = document.createElement('div');
        overlay.classList.add('overlay');
        
        slide.appendChild(img);
        slide.appendChild(overlay);
        swiperWrapper.appendChild(slide);
      });

      if (swiperInstance) {
        swiperInstance.destroy(true, true);
      }

      swiperInstance = new Swiper('.swiper', {
        loop: true,
        direction: 'horizontal',
        slidesPerView: 1,
        spaceBetween: 10
      });

      const newIndex = (currentIndex >= newTotalSlides) ? newTotalSlides - 1 : currentIndex;
      swiperInstance.slideToLoop(newIndex, 0);

      enviarDatosAAppInventor(swiperInstance.realIndex);

      swiperInstance.on('slideChange', () => {
        const realIndex = swiperInstance.realIndex;
        enviarDatosAAppInventor(realIndex);
      });

    } catch (error) {
      console.error("Error al cargar las im√°genes:", error);
    }
  }

  function enviarDatosAAppInventor(index) {
    if (window.AppInventor && anunciosData[index]) {
      window.AppInventor.setWebViewString(JSON.stringify(anunciosData[index]));
    }
  }

  function recargarDatos() {
    cargarImagenes();
  }

  cargarImagenes();
</script>
