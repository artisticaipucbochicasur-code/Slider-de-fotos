<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #111;
      font-family: Arial, sans-serif;
      color: white;
    }
    .swiper {
      width: 100vw;
      height: 100vh;
    }
    .swiper-slide {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      background: #000;
    }
    .swiper-slide img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .overlay {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: none;
      padding: 0;
      box-sizing: border-box;
    }
    /* Estilos para el indicador de carga */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      text-align: center;
      z-index: 10;
    }
    /* Animación para el emoji del reloj de arena */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #loader .spinner {
      display: inline-block;
      animation: spin 1.5s linear infinite;
    }
  </style>
</head>
<body>
  <div class="swiper">
    <div class="swiper-wrapper"></div>
  </div>
  <div id="loader"><span class="spinner">⏳</span></div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
    let anunciosData = {
        titulo: [],
        descripcion: [],
        comentarios: [],
        url: [],
        deleteurl: [],
        autor: [],
        correo: [],
        fecha: [],
        id: []
    };
    let swiperInstance = null;
    const loader = document.getElementById('loader');

    // Función para inicializar Swiper
    function initSwiper(initialIndex = 0) {
      if (swiperInstance) {
        swiperInstance.destroy(true, true);
      }
      swiperInstance = new Swiper('.swiper', {
        loop: true,
        direction: 'horizontal',
        slidesPerView: 1,
        spaceBetween: 10,
        // Habilitar el módulo de zoom de Swiper
        zoom: {
          maxRatio: 3, // Zoom máximo
          minRatio: 1, // Zoom mínimo
        },
      });
      swiperInstance.on('slideChange', () => {
        if (window.AppInventor && anunciosData.titulo.length > 0) {
          const realIndex = swiperInstance.realIndex;
          const currentAnuncio = {
            titulo: anunciosData.titulo[realIndex] || "",
            descripcion: anunciosData.descripcion[realIndex] || "",
            comentarios: anunciosData.comentarios[realIndex] || [],
            url: anunciosData.url[realIndex] || "",
            deleteurl: anunciosData.deleteurl[realIndex] || "",
            autor: anunciosData.autor[realIndex] || "",
            correo: anunciosData.correo[realIndex] || "",
            fecha: anunciosData.fecha[realIndex] || "",
            id: anunciosData.id[realIndex] || ""
          };
          window.AppInventor.setWebViewString(JSON.stringify(currentAnuncio));
        }
      });
      // Sincronizar el slider con el índice guardado
      if (anunciosData.titulo.length > 0) {
        const initialSlideIndex = Math.min(initialIndex, anunciosData.titulo.length - 1);
        swiperInstance.slideToLoop(initialSlideIndex, 0);
        if (window.AppInventor) {
          const firstAnuncio = {
            titulo: anunciosData.titulo[initialSlideIndex] || "",
            descripcion: anunciosData.descripcion[initialSlideIndex] || "",
            comentarios: anunciosData.comentarios[initialSlideIndex] || [],
            url: anunciosData.url[initialSlideIndex] || "",
            deleteurl: anunciosData.deleteurl[initialSlideIndex] || "",
            autor: anunciosData.autor[initialSlideIndex] || "",
            correo: anunciosData.correo[initialSlideIndex] || "",
            fecha: anunciosData.fecha[initialSlideIndex] || "",
            id: anunciosData.id[initialSlideIndex] || ""
          };
          window.AppInventor.setWebViewString(JSON.stringify(firstAnuncio));
        }
      }
    }

    // Función para cargar las imágenes desde el script
    async function cargarImagenes() {
      loader.style.display = 'block'; // Mostrar el loader

      try {
        const response = await fetch(`${SCRIPT_URL}?accion=listarAnuncios`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        
        // --- 1. CAMBIO: Cargar los datos directamente sin el `.anuncios` ---
        // Este ajuste es necesario porque el script ahora devuelve un objeto JSON plano
        const newAnunciosData = data;
        
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        const currentIndex = swiperInstance ? swiperInstance.realIndex : 0;
        
        // Comprobar si los datos han cambiado antes de actualizar
        const areDataEqual = JSON.stringify(anunciosData) === JSON.stringify(newAnunciosData);
        if (areDataEqual) {
          console.log("Datos no han cambiado, no se actualiza la UI.");
          loader.style.display = 'none';
          return;
        }

        anunciosData = newAnunciosData;
        
        // Limpiar slides existentes de forma eficiente
        swiperWrapper.innerHTML = '';
        
        // --- 2. CAMBIO: Recorrer el array de URLs para crear los slides ---
        // Se asegura de que la URL exista antes de crear un slide
        if (anunciosData.url && anunciosData.url.length > 0) {
          anunciosData.url.forEach((url, index) => {
            const slide = document.createElement('div');
            slide.classList.add('swiper-slide');

            // Contenedor de zoom requerido por Swiper
            const zoomContainer = document.createElement('div');
            zoomContainer.classList.add('swiper-zoom-container');
            
            const img = document.createElement('img');
            img.src = url;
            img.alt = anunciosData.titulo[index] || "";
            
            zoomContainer.appendChild(img);
            slide.appendChild(zoomContainer);
            swiperWrapper.appendChild(slide);
          });
        }

        // Re-inicializar Swiper con el índice anterior
        const newIndex = (currentIndex >= anunciosData.url.length) ? anunciosData.url.length - 1 : currentIndex;
        initSwiper(newIndex < 0 ? 0 : newIndex);
        
        console.log("Anuncios cargados y Swiper actualizado.");

      } catch (error) {
        console.error("Error al cargar las imágenes:", error);
      } finally {
        loader.style.display = 'none'; // Ocultar el loader
      }
    }

    // Expone la función de recarga para que App Inventor pueda llamarla
    window.recargarDatos = cargarImagenes;
    
    // Iniciar la carga de datos al abrir la app
    cargarImagenes();
  </script>
</body>
</html>
